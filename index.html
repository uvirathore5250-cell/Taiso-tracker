<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAISO CRM - SMART CALLS</title>
    <style>
        :root { --neon: #92d050; --bg: #000; --card: #111; --danger: #ff4444; --done: #4CAF50; --blue: #2196F3; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; padding: 0; margin: 0; padding-bottom: 85px; }
        
        /* Fixed Header */
        .header { position: fixed; top: 0; left: 0; width: 100%; background: #1a1a1a; padding: 15px 0; text-align: center; border-bottom: 2px solid var(--neon); z-index: 1000; }
        .status-sync { font-size: 10px; color: var(--neon); margin-top: 5px; opacity: 0.8; }

        /* Navigation Bottom */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; display: flex; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #666; font-weight: bold; cursor: pointer; font-size: 14px; }
        .nav-item.active { color: var(--neon); border-top: 3px solid var(--neon); background: #222; }

        .content-page { display: none; padding: 85px 15px 20px 15px; }
        .content-page.active { display: block; }

        /* Call Sub-Tabs (Alag Alag Options) */
        .call-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #111; color: #fff; font-size: 12px; font-weight: bold; }
        .tab-btn.active { background: #222; border-width: 2px; }
        .tab-pending.active { border-color: var(--danger); color: var(--danger); }
        .tab-done.active { border-color: var(--done); color: var(--done); }
        .tab-all.active { border-color: var(--blue); color: var(--blue); }

        /* Card Styling */
        .client-card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid #222; position: relative; }
        .history-box { font-size: 12px; background: #000; padding: 10px; border-radius: 8px; margin: 10px 0; color: #ccc; border: 1px dashed #444; white-space: pre-line; }
        
        .btn-row { display: flex; gap: 8px; }
        .act-btn { flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; border: none; font-size: 11px; cursor: pointer; }
        .btn-upd { background: #333; color: #fff; border: 1px solid var(--neon); }
        .btn-del { background: none; border: 1px solid var(--danger); color: var(--danger); }

        input, textarea, .save-btn { width: 100%; padding: 14px; margin: 8px 0; background: #050505; border: 1px solid #333; color: #fff; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .save-btn { background: var(--neon); color: #000; font-weight: bold; border: none; margin-top: 10px; }
        .update-form { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="header">
        <b style="letter-spacing: 2px;">TAISO CRM</b>
        <div id="syncStatus" class="status-sync">Connecting...</div>
    </div>

    <div id="page-add" class="content-page active">
        <div style="background:var(--card); padding:20px; border-radius:20px; border:1px solid #222;">
            <h3 style="margin-top:0; color:var(--neon)">Add Inquiry</h3>
            <input type="text" id="name" placeholder="Client Name">
            <input type="tel" id="phone" placeholder="Phone Number">
            <input type="date" id="visitDate">
            <textarea id="note" placeholder="Requirements..."></textarea>
            <button onclick="addClient()" id="mainBtn" class="save-btn">SAVE & CLOUD SYNC</button>
        </div>
    </div>

    <div id="page-call" class="content-page">
        <div class="call-tabs">
            <button class="tab-btn tab-pending active" onclick="setCallFilter('pending', this)">‚ö†Ô∏è PENDING</button>
            <button class="tab-btn tab-done" onclick="setCallFilter('done', this)">‚úÖ DONE</button>
            <button class="tab-btn tab-all" onclick="setCallFilter('all', this)">üìÇ ALL</button>
        </div>

        <input type="text" id="search" placeholder="üîç Search name or phone..." onkeyup="render()" style="margin-bottom:15px; border-color:var(--neon)">
        <div id="listContainer"></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('add', this)">‚ûï ADD</div>
        <div class="nav-item" onclick="nav('call', this)">üìû CALLS</div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbymfnVgpFjC2HEItC6P2v1moyt91xDx6MVu9k_dZ6w0hg0XUCYj7BuJ2ShYOflPxUjM/exec'; 
        let clients = JSON.parse(localStorage.getItem('crmData')) || [];
        let callFilter = 'pending';

        function nav(p, el) {
            document.querySelectorAll('.content-page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nv => nv.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            el.classList.add('active');
            if(p === 'call') sync();
        }

        function setCallFilter(f, el) {
            callFilter = f;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            render();
        }

        async function sync() {
            try {
                const res = await fetch(scriptURL + '?t=' + Date.now());
                const data = await res.json();
                if(Array.isArray(data)) {
                    clients = data;
                    localStorage.setItem('crmData', JSON.stringify(clients));
                    document.getElementById('syncStatus').innerText = "‚úÖ Online: " + new Date().toLocaleTimeString();
                    render();
                }
            } catch(e) { document.getElementById('syncStatus').innerText = "‚ö†Ô∏è Offline"; render(); }
        }

        function addClient() {
            const n = document.getElementById('name').value, p = document.getElementById('phone').value, d = document.getElementById('visitDate').value, nt = document.getElementById('note').value;
            if(n && d) {
                const ts = new Date().toLocaleString('en-IN');
                const payload = { name:n, phone:p, date:d, remarks:nt, history: `[${ts}] Initial: ${nt}` };
                document.getElementById('mainBtn').innerText = "Syncing...";
                fetch(scriptURL, { method:'POST', mode:'no-cors', body:JSON.stringify(payload) }).then(() => {
                    alert("Client Added!"); document.getElementById('name').value=''; document.getElementById('note').value='';
                    document.getElementById('mainBtn').innerText = "SAVE & CLOUD SYNC"; sync();
                });
            }
        }

        function updateCall(idx) {
            const nextD = document.getElementById(`d-${idx}`).value, msg = document.getElementById(`m-${idx}`).value;
            if(!nextD || !msg) return alert("Fill all details");
            
            const tsNow = new Date().toLocaleString('en-IN');
            const todayKey = new Date().toLocaleDateString('en-IN');
            const newHistory = clients[idx].history + `\n| [${tsNow}] DONE: ${msg}`;
            
            const payload = { name: clients[idx].name, phone: clients[idx].phone, date: nextD, remarks: msg, history: newHistory };
            fetch(scriptURL, { method:'POST', mode:'no-cors', body:JSON.stringify(payload) }).then(() => { sync(); });
        }

        function render() {
            const cont = document.getElementById('listContainer'), term = document.getElementById('search').value.toLowerCase();
            const today = new Date().toISOString().split('T')[0], todayKey = new Date().toLocaleDateString('en-IN');
            cont.innerHTML = '';

            [...clients].reverse().forEach((c) => {
                const rIdx = clients.indexOf(c);
                const isToday = c.date === today;
                const isDone = c.history && c.history.includes(`[${todayKey}] DONE:`);
                
                // Smart Logical Filter
                if(callFilter === 'pending' && !(isToday && !isDone)) return;
                if(callFilter === 'done' && !isDone) return;
                if(term && !c.name.toLowerCase().includes(term) && !c.phone.toString().includes(term)) return;

                const div = document.createElement('div');
                div.className = 'client-card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <b>${c.name} <small style="display:block; color:#666; font-weight:normal;">${c.phone}</small></b>
                        <b style="color:var(--neon); font-size:12px;">${c.date}</b>
                    </div>
                    <div class="history-box">${c.history}</div>
                    <div class="btn-row">
                        <button class="act-btn btn-upd" onclick="document.getElementById('f-${rIdx}').style.display='block'">üìû UPDATE CALL</button>
                        <button class="act-btn btn-del" onclick="if(confirm('Delete?')){clients.splice(${rIdx},1);render();}">üóëÔ∏è</button>
                    </div>
                    <div id="f-${rIdx}" class="update-form">
                        <small>Next Follow-up Date:</small>
                        <input type="date" id="d-${rIdx}" value="${c.date}">
                        <textarea id="m-${rIdx}" placeholder="What happened on call?"></textarea>
                        <button onclick="updateCall(${rIdx})" class="save-btn">SAVE & COMPLETE</button>
                    </div>
                `;
                cont.appendChild(div);
            });
        }
        window.onload = sync;
    </script>
</body>
</html>
